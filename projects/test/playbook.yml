- become: true
  hosts: lb_servers
  name: Configure Load Balancer servers
  tasks:
  - apt:
      cache_valid_time: 3600
      update_cache: true
    name: Update apt cache
    when: ansible_os_family == "Debian"
  - apt:
      name:
        rocky: &id002
        - nginx
        ubuntu: &id001
        - nginx
      state: present
    name: Install required packages
    when: ansible_os_family == "Debian"
  - name: Update package cache (Rocky/RHEL)
    when: ansible_os_family == "RedHat"
    yum:
      update_cache: true
  - apt:
      name: *id001
      state: present
    name: Install required packages (Ubuntu)
    when: ansible_os_family == "Debian"
  - name: Install required packages (Rocky)
    when: ansible_os_family == "RedHat"
    yum:
      name: *id002
      state: present
  - name: Start and enable nginx
    systemd:
      enabled: true
      name: nginx
      state: started
  - name: Enable EPEL repository
    yum:
      name: epel-release
      state: present
  - name: Disable SELinux (if needed)
    selinux:
      policy: targeted
      state: permissive
    when: ansible_selinux.status == "enabled"
