<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Proxmox 서버 관리</title>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    .server-form { border:1px solid #ccc; padding:10px; margin-bottom:10px; }
    .server-actions { display: flex; gap: 8px; }
    .server-list-table { width:100%; border-collapse:collapse; margin-top:30px; }
    .server-list-table th, .server-list-table td { border:1px solid #ccc; padding:6px; text-align:center; }
    .server-list-table tr.selected { background:#e0f7fa; }
  </style>
</head>
<body>
  <h2>서버 역할 선택</h2>
  <select id="role-select" multiple="multiple" style="width:300px;">
    {% for key, role in roles.items() %}
      <option value="{{ key }}">{{ role.name }}</option>
    {% endfor %}
  </select>

  <div id="server-forms"></div>

  <button id="create-servers-btn">서버 생성</button>

  <h2>활성화된 서버 리스트</h2>
  <table class="server-list-table" id="active-server-table">
    <thead>
      <tr><th>이름</th><th>역할</th><th>IP</th><th>상태</th><th>액션</th></tr>
    </thead>
    <tbody>
      <!-- 서버 리스트 동적 렌더링 -->
    </tbody>
  </table>

  <script>
  $(document).ready(function() {
    $('#role-select').select2({ placeholder: '역할을 선택/검색하세요' });

    // 역할 선택 시 서버 폼 동적 생성
    $('#role-select').on('change', function() {
      const selectedRoles = $(this).val() || [];
      let html = '';
      selectedRoles.forEach(function(role) {
        html += `<div class="server-form" data-role="${role}">
          <h4>${role} 서버 정보</h4>
          <label>이름: <input type="text" name="name_${role}" required></label><br>
          <label>CPU: <input type="number" name="cpu_${role}" value="2" min="1"></label><br>
          <label>메모리(MB): <input type="number" name="memory_${role}" value="2048" min="512"></label><br>
          <label>디스크(GB, 콤마로 구분): <input type="text" name="disks_${role}" value="20"></label><br>
          <label>네트워크(bridge,ip 콤마로 구분): <input type="text" name="networks_${role}" value="vmbr0,192.168.0.100"></label><br>
        </div>`;
      });
      $('#server-forms').html(html);
    });

    // 서버 생성 버튼 클릭
    $('#create-servers-btn').on('click', function() {
      const selectedRoles = $('#role-select').val() || [];
      let created = 0, failed = 0;
      selectedRoles.forEach(function(role) {
        const name = $(`input[name='name_${role}']`).val();
        const cpu = parseInt($(`input[name='cpu_${role}']`).val());
        const memory = parseInt($(`input[name='memory_${role}']`).val());
        const disks = $(`input[name='disks_${role}']`).val().split(',').map((v,i)=>({size:parseInt(v.trim()),interface:`scsi${i}`}));
        const networks = $(`input[name='networks_${role}']`).val().split(';').map((v)=>{
          const [bridge,ip] = v.split(',');
          return {bridge:bridge.trim(), ip_address:ip.trim()};
        });
        // 기본값 예시, 실제로는 폼에서 받거나 서버에서 결정
        const template_vm_id = (role==='web') ? 9000 : 8000;
        const data = {
          name, role, cpu, memory, disks, network_devices: networks, template_vm_id
        };
        $.ajax({
          url: '/add_server',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data),
          success: function(res) {
            created++;
            if (created+failed === selectedRoles.length) {
              alert('서버 생성 완료!');
              loadActiveServers();
            }
          },
          error: function(xhr) {
            failed++;
            alert('서버 생성 실패: ' + (xhr.responseJSON?.error || xhr.statusText));
            if (created+failed === selectedRoles.length) loadActiveServers();
          }
        });
      });
    });

    // 활성화된 서버 리스트 불러오기
    function loadActiveServers() {
      $.get('/servers', function(res) {
        let html = '';
        for (const [name, s] of Object.entries(res.servers)) {
          html += `<tr data-server="${name}">
            <td>${s.name}</td>
            <td>${s.role}</td>
            <td>${(s.network_devices && s.network_devices.length > 0) ? s.network_devices.map(nd=>nd.ip_address).join(', ') : ''}</td>
            <td>활성</td>
            <td class="server-actions">
              <button class="stop-btn">중지</button>
              <button class="reboot-btn">리부팅</button>
              <button class="delete-btn">삭제</button>
            </td>
          </tr>`;
        }
        $('#active-server-table tbody').html(html);
      });
    }
    loadActiveServers();

    // 서버 액션 버튼 이벤트 (API 연동 필요)
    $('#active-server-table').on('click', '.stop-btn', function() {
      const name = $(this).closest('tr').data('server');
      $.post('/stop_server/' + name, function(res) {
        alert(res.message);
        loadActiveServers();
      }).fail(function(xhr){
        alert('중지 실패: ' + (xhr.responseJSON?.error || xhr.statusText));
      });
    });
    $('#active-server-table').on('click', '.reboot-btn', function() {
      const name = $(this).closest('tr').data('server');
      $.post('/reboot_server/' + name, function(res) {
        alert(res.message);
        loadActiveServers();
      }).fail(function(xhr){
        alert('리부팅 실패: ' + (xhr.responseJSON?.error || xhr.statusText));
      });
    });
    $('#active-server-table').on('click', '.delete-btn', function() {
      const name = $(this).closest('tr').data('server');
      if(confirm(name + ' 서버를 삭제하시겠습니까?')) {
        $.post('/delete_server/' + name, function(res) {
          alert(res.message);
          loadActiveServers();
        });
      }
    });
  });
  </script>
</body>
</html>