#cloud-config
# Proxmox Manager ê³µí†µ ì„¤ì •

# ê¸°ë³¸ ì‚¬ìš©ì ì„¤ì • (ê¸°ì¡´ ì‚¬ìš©ì ìœ ì§€)
users:
  - name: ${vm_username}
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    passwd: ${vm_password}
    ssh_authorized_keys:
      - ${ssh_public_key}

# dev ì‚¬ìš©ì ì¶”ê°€ (ìƒˆë¡œìš´ ê³µí†µ ì‚¬ìš©ì)
  - name: dev
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    passwd: dev1234
    groups: [wheel, sudo]
    ssh_authorized_keys:
      - ${ssh_public_key}

# íŒ¨í‚¤ì§€ ì„¤ì¹˜
packages:
  - curl
  - wget
  - vim
  - htop
  - net-tools
  - tree
  - jq
  - chrony

# ì„œë¹„ìŠ¤ ì„¤ì •
runcmd:
  # ì‹œê°„ëŒ€ë¥¼ KSTë¡œ ë³€ê²½
  - timedatectl set-timezone Asia/Seoul
  - systemctl enable chronyd
  - systemctl start chronyd
  
  # SELinux ë¹„í™œì„±í™”
  - setenforce 0
  - sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
  
  # Firewalld ë¹„í™œì„±í™”
  - systemctl stop firewalld
  - systemctl disable firewalld
  
  # SSH ì„¤ì • (íŒ¨ìŠ¤ì›Œë“œ ì¸ì¦ í—ˆìš©)
  - sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - sed -i 's/^#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
  - systemctl restart sshd
  
  # í˜¸ìŠ¤íŠ¸ëª… ì„¤ì •
  - hostnamectl set-hostname ${vm_name}
  
  # ë¡œì¼€ì¼ ì„¤ì •
  - localectl set-locale LANG=ko_KR.UTF-8
  - localectl set-keymap ko
  
  # ê¸°ë³¸ ë””ë ‰í† ë¦¬ ìƒì„±
  - mkdir -p /home/dev/.ssh
  - chown -R dev:dev /home/dev/.ssh
  - chmod 700 /home/dev/.ssh
  
  # ë¡œê·¸ íŒŒì¼ ìƒì„±
  - touch /var/log/proxmox-manager-init.log
  - chmod 644 /var/log/proxmox-manager-init.log

# íŒŒì¼ ìƒì„±
write_files:
  - path: /etc/motd
    content: |
      ==========================================
      ğŸš€ Proxmox Manager ìë™ ìƒì„± ì„œë²„
      ==========================================
      ì„œë²„ëª…: ${vm_name}
      ì—­í• : ${vm_role}
      ìƒì„±ì¼: $(date)
      ì‚¬ìš©ì: ${vm_username}, dev
      ì‹œê°„ëŒ€: Asia/Seoul (KST)
      ==========================================
    permissions: '0644'
    owner: root:root

  - path: /home/dev/.bashrc
    content: |
      # Proxmox Manager dev ì‚¬ìš©ì ì„¤ì •
      export PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
      export LANG=ko_KR.UTF-8
      export LC_ALL=ko_KR.UTF-8
      
      # ìœ ìš©í•œ ë³„ì¹­
      alias ll='ls -alF'
      alias la='ls -A'
      alias l='ls -CF'
      alias ..='cd ..'
      alias ...='cd ../..'
      
      # ë¡œê·¸ í™•ì¸
      alias logs='tail -f /var/log/proxmox-manager-init.log'
    permissions: '0644'
    owner: dev:dev

  - path: /etc/sudoers.d/dev
    content: |
      # dev ì‚¬ìš©ì sudo ê¶Œí•œ
      dev ALL=(ALL) NOPASSWD:ALL
    permissions: '0440'
    owner: root:root

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  - PROXMOX_MANAGER_SERVER: "true"
  - VM_ROLE: "${vm_role}"
  - VM_NAME: "${vm_name}"
  - TIMEZONE: "Asia/Seoul"
  - DEFAULT_USER: "dev"

# ìµœì¢… ì‹¤í–‰ ëª…ë ¹
final_message: "Proxmox Manager ì„œë²„ ì´ˆê¸°í™” ì™„ë£Œ: ${vm_name} (KST, dev ì‚¬ìš©ì, SELinux/Firewalld ë¹„í™œì„±í™”)"
