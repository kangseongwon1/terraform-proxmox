#cloud-config
# Proxmox Manager 공통 설정

# 기본 사용자 설정 (기존 사용자 유지)
users:
  - name: ${vm_username}
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    passwd: ${vm_password}
    ssh_authorized_keys:
      - ${ssh_public_key}

# dev 사용자 추가 (새로운 공통 사용자)
  - name: dev
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    passwd: dev1234
    groups: [wheel, sudo]
    ssh_authorized_keys:
      - ${ssh_public_key}

# 패키지 설치
packages:
  - curl
  - wget
  - vim
  - htop
  - net-tools
  - tree
  - jq
  - chrony

# 서비스 설정
runcmd:
  # 시간대를 KST로 변경
  - timedatectl set-timezone Asia/Seoul
  - systemctl enable chronyd
  - systemctl start chronyd
  
  # SELinux 비활성화
  - setenforce 0
  - sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
  
  # Firewalld 비활성화
  - systemctl stop firewalld
  - systemctl disable firewalld
  
  # SSH 설정 (패스워드 인증 허용)
  - sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - sed -i 's/^#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
  - systemctl restart sshd
  
  # 호스트명 설정
  - hostnamectl set-hostname ${vm_name}
  
  # 로케일 설정
  - localectl set-locale LANG=ko_KR.UTF-8
  - localectl set-keymap ko
  
  # 기본 디렉토리 생성
  - mkdir -p /home/dev/.ssh
  - chown -R dev:dev /home/dev/.ssh
  - chmod 700 /home/dev/.ssh
  
  # 로그 파일 생성
  - touch /var/log/proxmox-manager-init.log
  - chmod 644 /var/log/proxmox-manager-init.log

# 파일 생성
write_files:
  - path: /etc/motd
    content: |
      ==========================================
      🚀 Proxmox Manager 자동 생성 서버
      ==========================================
      서버명: ${vm_name}
      역할: ${vm_role}
      생성일: $(date)
      사용자: ${vm_username}, dev
      시간대: Asia/Seoul (KST)
      ==========================================
    permissions: '0644'
    owner: root:root

  - path: /home/dev/.bashrc
    content: |
      # Proxmox Manager dev 사용자 설정
      export PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
      export LANG=ko_KR.UTF-8
      export LC_ALL=ko_KR.UTF-8
      
      # 유용한 별칭
      alias ll='ls -alF'
      alias la='ls -A'
      alias l='ls -CF'
      alias ..='cd ..'
      alias ...='cd ../..'
      
      # 로그 확인
      alias logs='tail -f /var/log/proxmox-manager-init.log'
    permissions: '0644'
    owner: dev:dev

  - path: /etc/sudoers.d/dev
    content: |
      # dev 사용자 sudo 권한
      dev ALL=(ALL) NOPASSWD:ALL
    permissions: '0440'
    owner: root:root

# 환경 변수 설정
env:
  - PROXMOX_MANAGER_SERVER: "true"
  - VM_ROLE: "${vm_role}"
  - VM_NAME: "${vm_name}"
  - TIMEZONE: "Asia/Seoul"
  - DEFAULT_USER: "dev"

# 최종 실행 명령
final_message: "Proxmox Manager 서버 초기화 완료: ${vm_name} (KST, dev 사용자, SELinux/Firewalld 비활성화)"
